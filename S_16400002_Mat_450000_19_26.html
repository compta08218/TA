<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau d'Amortissement Dynamique</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        header h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .loan-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #ecf0f1;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }

        .summary-item {
            padding: 10px;
        }

        .summary-item strong {
            display: block;
            color: #34495e;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .summary-item span, .summary-item input {
            font-size: 1.2em;
            color: #2980b9;
            font-weight: 500;
            width: calc(100% - 10px);
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            position: relative; 
            height: 40vh; /* Hauteur fixe pour le conteneur */
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .full-width-chart-container {
            grid-column: 1 / -1; /* Span full width */
            height: 50vh; /* Hauteur fixe pour le conteneur */
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
        }

        .chart-container h3 {
            text-align: center;
            color: #34495e;
            margin-top: 0;
        }

        .controls {
            text-align: right;
            margin-bottom: 20px;
        }

        .controls button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .controls button:hover {
            background-color: #2980b9;
        }

        details {
            margin-bottom: 15px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            overflow: hidden;
        }

        summary {
            padding: 15px;
            font-size: 1.3em;
            font-weight: 500;
            background-color: #34495e;
            color: white;
            cursor: pointer;
            outline: none;
            transition: background-color 0.3s ease;
        }
        
        details[open] > summary {
            background-color: #2c3e50;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::before {
            content: '+';
            margin-right: 10px;
            font-weight: bold;
        }

        details[open] summary::before {
            content: '-';
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #ecf0f1;
            font-weight: 500;
            color: #34495e;
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tbody tr:hover {
            background-color: #e8f4fd;
        }

        tfoot {
            font-weight: bold;
            background-color: #eaf2f8;
        }

        tfoot td {
            border-top: 2px solid #3498db;
        }

        td:first-child, th:first-child {
            text-align: left;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Tableau d'Amortissement</h1>
                <button id="logout-button" style="background-color: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease;">Se déconnecter</button>
            </div>
            <div class="loan-summary">
                <div class="summary-item"><strong>N° Dossier:</strong> <span>16400002</span></div>
                <div class="summary-item"><strong>Emprunteur:</strong> <span>BAKITO</span></div>
                <div class="summary-item"><strong>Montant du Prêt:</strong> <span>450 000,00 €</span></div>
                <div class="summary-item"><strong>Durée:</strong> <span>84 Mois</span></div>
                <div class="summary-item"><strong>Taux Nominal:</strong> <span>0,990 %</span></div>
                <div class="summary-item"><strong>Total des Intérêts:</strong> <span>15 733,56 €</span></div>
                <div class="summary-item"><strong>Coût Total du Crédit:</strong> <span>465 733,56 €</span></div>
            </div>
        </header>

        <main>
            <section class="charts-section">
                <div class="chart-container">
                    <h3>Évolution du Capital Restant Dû</h3>
                    <canvas id="balance-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Répartition Capital vs. Intérêts</h3>
                    <canvas id="pie-chart"></canvas>
                </div>
                <div class="full-width-chart-container">
                    <h3>Composition des Échéances (Capital vs. Intérêts)</h3>
                    <canvas id="stacked-bar-chart"></canvas>
                </div>
            </section>

            <div class="controls">
                <button id="expand-all">Tout Déplier</button>
                <button id="collapse-all">Tout Replier</button>
            </div>

            <div id="amortization-schedule">
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const amortizationData = {
                "2019": [
                    ["15/03/2019","5175.87","235.74","280574.43","5411.61"],
                    ["15/04/2019","5180.14","220.05","415976.67","5485.06"],
                    ["15/05/2019","5184.41","307.31","424614.86","5537.48"],
                    ["15/06/2019","5188.69","350.31","419426.17","5539.00"],
                    ["15/07/2019","5192.97","346.03","414233.20","5539.00"],
                    ["15/08/2019","5197.26","303.22","418880.66","5546.05"],
                    ["15/09/2019","5201.54","345.58","413679.12","5547.12"],
                    ["15/10/2019","5205.83","341.29","408473.29","5547.12"],
                    ["15/11/2019","5210.13","336.99","403263.16","5547.12"],
                    ["15/12/2019","5214.43","332.69","398048.73","5547.12"]
                ],
                "2020": [
                    ["15/01/2020","5218.73","328.39","392830.00","5547.12"],
                    ["15/02/2020","5223.04","324.08","387606.96","5547.12"],
                    ["15/03/2020","5227.34","319.78","382379.62","5547.12"],
                    ["15/04/2020","5231.66","315.46","377147.96","5547.12"],
                    ["15/05/2020","5235.97","311.15","371911.99","5547.12"],
                    ["15/06/2020","5240.29","306.83","366671.70","5547.12"],
                    ["15/07/2020","5244.62","302.50","361427.08","5547.12"],
                    ["15/08/2020","5248.94","298.18","356178.14","5547.12"],
                    ["15/09/2020","5253.27","293.85","350924.87","5547.12"],
                    ["15/10/2020","5257.61","289.51","345667.26","5547.12"],
                    ["15/11/2020","5261.94","285.18","340405.32","5547.12"],
                    ["15/12/2020","5266.29","280.83","335139.03","5547.12"]
                ],
                "2021": [
                    ["15/01/2021","5270.63","276.49","329868.40","5547.12"],
                    ["15/02/2021","5274.98","272.14","324593.42","5547.12"],
                    ["15/03/2021","5279.33","267.79","319314.09","5547.12"],
                    ["15/04/2021","5283.69","263.43","314030.40","5547.12"],
                    ["15/05/2021","5288.04","259.08","308742.36","5547.12"],
                    ["15/06/2021","5292.41","254.71","303449.95","5547.12"],
                    ["15/07/2021","5296.77","250.35","298153.18","5547.12"],
                    ["15/08/2021","5301.14","245.98","292852.04","5547.12"],
                    ["15/09/2021","5305.52","241.60","287546.52","5547.12"],
                    ["15/10/2021","5309.89","237.23","282236.63","5547.12"],
                    ["15/11/2021","5314.27","232.85","276922.36","5547.12"],
                    ["15/12/2021","5318.66","228.46","271603.70","5547.12"]
                ],
                "2022": [
                    ["15/01/2022","5323.05","224.07","266280.65","5547.12"],
                    ["15/02/2022","5327.44","219.68","260953.21","5547.12"],
                    ["15/03/2022","5331.83","215.29","255621.38","5547.12"],
                    ["15/04/2022","5336.23","210.89","250285.15","5547.12"],
                    ["15/05/2022","5340.63","206.49","244944.52","5547.12"],
                    ["15/06/2022","5345.04","202.08","239599.48","5547.12"],
                    ["15/07/2022","5349.45","197.67","234250.03","5547.12"],
                    ["15/08/2022","5353.86","193.26","228896.17","5547.12"],
                    ["15/09/2022","5358.28","188.84","223537.89","5547.12"],
                    ["15/10/2022","5362.70","184.42","218175.19","5547.12"],
                    ["15/11/2022","5367.13","179.99","212808.06","5547.12"],
                    ["15/12/2022","5371.55","175.57","207436.51","5547.12"]
                ],
                "2023": [
                    ["15/01/2023","5375.98","171.14","202060.53","5547.12"],
                    ["15/02/2023","5380.42","166.70","196680.11","5547.12"],
                    ["15/03/2023","5384.86","162.26","191295.25","5547.12"],
                    ["15/04/2023","5389.30","157.82","185905.95","5547.12"],
                    ["15/05/2023","5393.75","153.37","180512.20","5547.12"],
                    ["15/06/2023","5398.20","148.92","175114.00","5547.12"],
                    ["15/07/2023","5402.65","144.47","169711.35","5547.12"],
                    ["15/08/2023","5407.11","140.01","164304.24","5547.12"],
                    ["15/09/2023","5411.57","135.55","158892.67","5547.12"],
                    ["15/10/2023","5416.03","131.09","153476.64","5547.12"],
                    ["15/11/2023","5420.50","126.62","148056.14","5547.12"],
                    ["15/12/2023","5424.97","122.15","142631.17","5547.12"]
                ],
                "2024": [
                    ["15/01/2024","5429.45","117.67","137201.72","5547.12"],
                    ["15/02/2024","5433.93","113.19","131767.79","5547.12"],
                    ["15/03/2024","5438.41","108.71","126329.38","5547.12"],
                    ["15/04/2024","5442.90","104.22","120886.48","5547.12"],
                    ["15/05/2024","5447.39","99.73","115439.09","5547.12"],
                    ["15/06/2024","5451.88","95.24","109987.21","5547.12"],
                    ["15/07/2024","5456.38","90.74","104530.83","5547.12"],
                    ["15/08/2024","5460.88","86.24","99069.95","5547.12"],
                    ["15/09/2024","5465.39","81.73","93604.56","5547.12"],
                    ["15/10/2024","5469.90","77.22","88134.66","5547.12"],
                    ["15/11/2024","5474.41","72.71","82660.25","5547.12"],
                    ["15/12/2024","5478.93","68.19","77181.32","5547.12"]
                ],
                "2025": [
                    ["15/01/2025","5483.45","63.67","71697.87","5547.12"],
                    ["15/02/2025","5487.97","59.15","66209.90","5547.12"],
                    ["15/03/2025","5492.50","54.62","60717.40","5547.12"],
                    ["15/04/2025","5497.03","50.09","55220.37","5547.12"],
                    ["15/05/2025","5501.56","45.56","49718.81","5547.12"],
                    ["15/06/2025","5506.10","41.02","44212.71","5547.12"],
                    ["15/07/2025","5510.64","36.48","38702.07","5547.12"],
                    ["15/08/2025","5515.19","31.93","33186.88","5547.12"],
                    ["15/09/2025","5519.74","27.38","27667.14","5547.12"],
                    ["15/10/2025","5524.29","22.83","22142.85","5547.12"],
                    ["15/11/2025","5528.85","18.27","16614.00","5547.12"],
                    ["15/12/2025","5533.41","13.71","11080.59","5547.12"]
                ],
                "2026": [
                    ["15/01/2026","5537.98","9.14","5542.61","5547.12"],
                    ["15/02/2026","5542.61","4.51","0.00","5547.12"]
                ]
            };

            const scheduleDiv = document.getElementById('amortization-schedule');
            for (const year in amortizationData) {
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                summary.textContent = `Année ${year}`;
                details.appendChild(summary);

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                thead.innerHTML = `<tr><th>Échéance</th><th>Capital Amorti</th><th>Intérêts</th><th>Restant Dû</th><th>Total Échéance</th></tr>`;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                amortizationData[year].forEach(rowData => {
                    const tr = document.createElement('tr');
                    rowData.forEach((cellData, index) => {
                        const td = document.createElement('td');
                        td.textContent = index > 0 ? `${parseFloat(cellData).toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}` : cellData;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                details.appendChild(table);
                scheduleDiv.appendChild(details);
            }

            const expandBtn = document.getElementById('expand-all');
            const collapseBtn = document.getElementById('collapse-all');
            const detailsElements = document.querySelectorAll('details');

            expandBtn.addEventListener('click', () => {
                detailsElements.forEach(detail => detail.open = true);
            });

            collapseBtn.addEventListener('click', () => {
                detailsElements.forEach(detail => detail.open = false);
            });

            // Automatically open the current year's details
            const currentYear = new Date().getFullYear();
            let opened = false;
            detailsElements.forEach(detail => {
                const summaryText = detail.querySelector('summary').textContent;
                if (summaryText.includes(currentYear)) {
                    detail.open = true;
                    opened = true;
                } else {
                    detail.open = false;
                }
            });

            // If no details for the current year are found, open the first one
            if (!opened && detailsElements.length > 0) {
                detailsElements[0].open = true;
            }

            // --- Chart Data ---
            const principal = 450000;
            const totalInterest = 15733.56;
            const allData = Object.values(amortizationData).flat();
            const dates = allData.map(row => row[0]);
            const amortissements = allData.map(row => parseFloat(row[1]));
            const interests = allData.map(row => parseFloat(row[2]));
            const remainingBalances = allData.map(row => parseFloat(row[3]));

            // --- Balance Chart (Line) ---
            const balanceCtx = document.getElementById('balance-chart').getContext('2d');
            new Chart(balanceCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Capital Restant Dû',
                        data: remainingBalances,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: { callback: value => value.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }) }
                        }
                    }
                }
            });

            // --- Pie Chart ---
            const pieCtx = document.getElementById('pie-chart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['Capital Emprunté', 'Coût des Intérêts'],
                    datasets: [{
                        data: [principal, totalInterest],
                        backgroundColor: ['#2ecc71', '#e74c3c'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                }
            });

            // --- Stacked Bar Chart with Today Line ---
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayIndex = dates.findIndex(dateStr => {
                const [day, month, year] = dateStr.split('/');
                if (!day || !month || !year) return false;
                const échéanceDate = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
                return échéanceDate > today;
            });

            const annotationPlugin = {
                id: 'todayLine',
                afterDraw: (chart) => {
                    if (todayIndex >= 0) {
                        const ctx = chart.ctx;
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        const xPos = (xAxis.getPixelForValue(todayIndex, todayIndex) + xAxis.getPixelForValue(todayIndex - 1, todayIndex -1)) / 2;

                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(xPos, yAxis.top);
                        ctx.lineTo(xPos, yAxis.bottom);
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)';
                        ctx.setLineDash([5, 5]); // Dotted line
                        ctx.stroke();
                        
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.textAlign = 'center';
                        ctx.fillText("Aujourd'hui", xPos, yAxis.top - 8);
                        
                        ctx.restore();
                    }
                }
            };

            const stackedBarCtx = document.getElementById('stacked-bar-chart').getContext('2d');
            new Chart(stackedBarCtx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Capital Remboursé',
                            data: amortissements,
                            backgroundColor: '#2ecc71',
                        },
                        {
                            label: 'Intérêts Payés',
                            data: interests,
                            backgroundColor: '#e74c3c',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            ticks: { callback: value => value.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }) }
                        }
                    }
                },
                plugins: [annotationPlugin]
            });
        });
    </script>

</body>
</html>
